<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Welcome - Fashionista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary-pink: #ff69b4;
      --light-pink: #ffb6c1;
      --black: #111;
      --white: #fff;
      --font-main: 'Montserrat', sans-serif;
      --font-heading: 'Playfair Display', serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background-color: var(--black);
      color: var(--white);
      line-height: 1.6;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Navbar */
    .navbar {
      background: var(--black);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      border-bottom: 1px solid var(--light-pink);
    }

    .logo {
      font-family: var(--font-heading);
      font-size: 1.8em;
      color: var(--primary-pink);
      font-weight: bold;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    .nav-links li a {
      color: var(--white);
      font-weight: 600;
      padding: 10px 15px;
      border-radius: 5px;
      transition: background 0.3s ease;
    }

    .nav-links li a:hover,
    .nav-links li a.active {
      background: var(--primary-pink);
      color: var(--black);
    }

    /* Hero Section */
    .hero {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      padding: 60px 40px;
      background: linear-gradient(to right, #111, #1a1a1a);
    }

    .hero-text {
      flex: 1;
      max-width: 600px;
    }

    .hero-text h1 {
      font-family: var(--font-heading);
      font-size: 3.5em;
      margin-bottom: 20px;
    }

    .highlight {
      color: var(--primary-pink);
    }

    .hero-text p {
      font-size: 1.2em;
      color: #ccc;
      margin-bottom: 30px;
    }

    .hero-buttons .btn {
      display: inline-block;
      padding: 12px 25px;
      margin-right: 15px;
      font-weight: 600;
      border-radius: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .btn.pink {
      background: var(--primary-pink);
      color: var(--black);
    }

    .btn.pink:hover {
      background: var(--light-pink);
    }

    .btn.outline {
      border: 2px solid var(--primary-pink);
      color: var(--primary-pink);
      background: transparent;
    }

    .btn.outline:hover {
      background: var(--primary-pink);
      color: var(--black);
    }

    .hero-icons {
      flex: 1;
      text-align: center;
      font-size: 5em;
      color: var(--light-pink);
    }

    .hero-icons i {
      margin: 0 15px;
      transition: transform 0.3s ease;
    }

    .hero-icons i:hover {
      transform: scale(1.2);
      color: var(--primary-pink);
    }

    /* Products Section */
    .products {
      padding: 60px 40px;
      text-align: center;
    }

    .products h2 {
      font-family: var(--font-heading);
      font-size: 2.5em;
      color: var(--primary-pink);
      margin-bottom: 40px;
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
    }

    .card {
  background: #1e1e1e;
  border-radius: 15px;
  overflow: hidden;
  width: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding-bottom: 20px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.card:hover {
  transform: translateY(-10px);
  box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
}

.card img {
  width: 100%;
  max-height: 220px;
  object-fit: contain; /* shows full image without cropping */
  background-color: #fff; /* optional: to show white background if image has transparency */
  padding: 10px;
}

.card h3 {
  color: var(--light-pink);
  margin-top: 10px;
  font-size: 1.2em;
}

.card p {
  color: #ccc;
  font-size: 0.95em;
  padding: 0 15px;
  margin: 10px 0;
  min-height: 50px; /* makes all texts roughly equal height */
}

.btn.small {
  font-size: 0.9em;
  padding: 10px 20px;
  margin-top: auto;
  background: var(--primary-pink);
  color: var(--black);
  border-radius: 20px;
  display: inline-block;
  margin-bottom: 15px;
}

    .btn.small:hover {
      background: var(--light-pink);
    }

    .view-reviews-btn:hover {
      background: #e754a0 !important;
      color: white !important;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 105, 180, 0.4);
    }

    .product-reviews {
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 105, 180, 0.2);
    }

    .product-reviews:hover {
      background: rgba(255, 255, 255, 0.15) !important;
      border-color: rgba(255, 105, 180, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 105, 180, 0.2);
    }

    .reviews-summary {
      transition: opacity 0.3s ease;
    }

    .rating-stars {
      filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.3));
    }

    /* Search and Clear button styles */
    #searchBtn:hover {
      background: #e754a0 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
    }

    #clearBtn:hover {
      background: #5a6268 !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
    }

    #searchBtn, #clearBtn {
      transition: all 0.3s ease;
      font-weight: 600;
    }

    /* Enhanced autocomplete styling */
    #autocompleteDropdown {
      border: 2px solid #ff69b4 !important;
      box-shadow: 0 8px 25px rgba(255, 105, 180, 0.2) !important;
    }

    .autocomplete-item:hover {
      background: #fff5f8 !important;
      border-left: 3px solid #ff69b4;
    }

    .autocomplete-item.selected {
      background: #ffeef5 !important;
      border-left: 3px solid #ff69b4;
    }

    footer {
      background: #0d0d0d;
      color: #aaa;
      text-align: center;
      padding: 20px 0;
      font-size: 0.9em;
      margin-top: 60px;
    }

    /* Autocomplete styling */
    #autocompleteDropdown .autocomplete-item:hover,
    #autocompleteDropdown .autocomplete-item.selected {
      background-color: #f0f0f0;
    }

    #autocompleteDropdown .autocomplete-item:last-child {
      border-bottom: none;
    }

    @media (max-width: 768px) {
      .hero {
        flex-direction: column;
        text-align: center;
      }

      .hero-text,
      .hero-icons {
        max-width: 100%;
      }

      .card-container {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="logo">Fashionista</div>
    <ul class="nav-links">
      <li><a href="guest.html" class="active"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="login.html"><i class="fas fa-sign-in-alt"></i> Login</a></li>
      <li><a href="register.html"><i class="fas fa-user-plus"></i> Register</a></li>
    </ul>
  </nav>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-text">
      <h1>Unleash Your <span class="highlight">Fashion</span></h1>
      <p>Style isn't just about what you wearâ€”it's how you express yourself. Shop our classy, elegant collections.</p>
      <div class="hero-buttons">
        <a href="register.html" class="btn pink"><i class="fas fa-user-plus"></i> Register</a>
        <a href="login.html" class="btn outline"><i class="fas fa-sign-in-alt"></i> Login</a>
      </div>
    </div>
    <div class="hero-icons">
      <i class="fas fa-tshirt"></i>
      <i class="fas fa-gem"></i>
      <i class="fas fa-shoe-prints"></i>
    </div>

  
  </section>

  <!-- Featured Products -->
  <section class="products">
    <h2>Featured Collections</h2>
    <div class="search-filter" style="display:flex;justify-content:center;gap:20px;margin-bottom:30px;position:relative;">
      <div style="position:relative;display:inline-block;">
        <input type="text" id="searchBox" placeholder="Search products..." style="padding:10px 18px;border-radius:20px;border:none;width:220px;font-size:1em;">
        <div id="autocompleteDropdown" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:8px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
      </div>
      <select id="categoryFilter" style="padding:10px 18px;border-radius:20px;border:none;width:180px;font-size:1em;">
        <option value="">All Categories</option>
        <option value="dress">Dresses</option>
        <option value="jewelry">Jewelry</option>
        <option value="shoes">Shoes</option>
        <option value="bags">Bags</option>
        <option value="accessories">Accessories</option>
      </select>
      <button id="searchBtn" class="btn small" style="margin:0;background:#ff69b4;color:white;">
        <i class="fas fa-search"></i> Search
      </button>
      <button id="clearBtn" class="btn small" style="margin:0;background:#6c757d;color:white;">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>
    <div class="card-container" id="guestProducts"></div>
    <div id="infiniteLoader" style="text-align:center;display:none;color:#ff69b4;font-weight:600;margin:20px 0;">Loading more products...</div>
  </section>

  <script>
    $(document).ready(function () {
      let allProducts = [];
      let filteredProducts = [];
      let currentPage = 1;
      const productsPerPage = 8;
      let loading = false;
      let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
      let selectedAutocompleteIndex = -1;

      // Generate star HTML for ratings
      function generateStarHTML(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
          if (i <= rating) {
            html += '<i class="fas fa-star" style="color: #ffd700;"></i>';
          } else {
            html += '<i class="far fa-star" style="color: #ccc;"></i>';
          }
        }
        return html;
      }

      // Show reviews modal
      function showReviewsModal(itemId, itemName) {
        // Fetch reviews for this item
        fetch(`http://localhost:3000/api/v1/items/${itemId}/reviews`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              displayReviewsModal(data.reviews, data.average_rating, data.total_reviews, itemName);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load reviews'
              });
            }
          })
          .catch(error => {
            console.error('Error fetching reviews:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to load reviews'
            });
          });
      }

      // Display reviews in modal
      function displayReviewsModal(reviews, averageRating, totalReviews, itemName) {
        let html = `
          <div class="reviews-modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 700px; max-height: 85vh; overflow-y: auto; color: #333; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="reviews-header" style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #ff69b4; padding-bottom: 20px;">
              <h3 style="color: #ff69b4; font-family: 'Playfair Display', serif; font-size: 2.2em; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(255,105,180,0.1);">${itemName}</h3>
              <div class="average-rating" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <div class="rating-stars" style="font-size: 24px; filter: drop-shadow(0 2px 4px rgba(255,215,0,0.3));">
                  ${generateStarHTML(averageRating)}
                </div>
                <span style="font-weight: bold; color: #333; font-size: 18px;">${averageRating} out of 5</span>
                <span style="color: #666; font-size: 16px;">(${totalReviews} reviews)</span>
              </div>
            </div>
        `;

        if (reviews.length === 0) {
          html += '<p style="text-align: center; color: #666; font-style: italic;">No reviews yet. Be the first to review this product!</p>';
        } else {
          html += '<div class="reviews-list" style="max-height: 400px; overflow-y: auto;">';
          reviews.forEach(review => {
            const date = new Date(review.created_at).toLocaleDateString();
            html += `
              <div class="review-item" style="border: 2px solid #eee; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, #f9f9f9 0%, #f0f0f0 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.3s ease;">
                <div class="review-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <div class="reviewer-info" style="display: flex; align-items: center; gap: 12px;">
                    <img src="${review.profile_picture || '/images/default-avatar.png'}" alt="User" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ff69b4;">
                    <span style="font-weight: bold; color: #333; font-size: 16px;">${review.user_name}</span>
                  </div>
                  <div class="review-rating" style="display: flex; align-items: center; gap: 12px;">
                    <div class="rating-stars" style="font-size: 16px; filter: drop-shadow(0 1px 2px rgba(255,215,0,0.3));">
                      ${generateStarHTML(review.rating)}
                    </div>
                    <span style="color: #666; font-size: 14px; font-weight: 500;">${date}</span>
                  </div>
                </div>
                <div class="review-comment" style="color: #333; line-height: 1.6; font-size: 15px;">
                  <p>${review.comment || 'No comment provided'}</p>
                </div>
              </div>
            `;
          });
          html += '</div>';
        }

        html += `
          <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 2px solid #ff69b4; background: linear-gradient(135deg, #fff5f8 0%, #ffeef5 100%); border-radius: 10px; padding: 20px;">
            <p style="color: #333; margin-bottom: 20px; font-size: 16px; font-weight: 600;">Want to leave a review?</p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
              <a href="login.html" class="btn" style="background: #ff69b4; color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255,105,180,0.3);">
                <i class="fas fa-sign-in-alt"></i> Login to Review
              </a>
              <a href="register.html" class="btn" style="background: #333; color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                <i class="fas fa-user-plus"></i> Register to Review
              </a>
            </div>
          </div>
        </div>
        `;

        Swal.fire({
          title: '',
          html: html,
          showConfirmButton: false,
          showCloseButton: true,
          width: 'auto',
          customClass: {
            container: 'reviews-modal-container'
          }
        });
      }

      // Autocomplete functionality
      function showAutocomplete(query) {
        if (!query || !query.trim()) {
          $('#autocompleteDropdown').hide();
          return;
        }

        const suggestions = [];
        const queryLower = query.toLowerCase();

        // Add product name suggestions
        allProducts.forEach(product => {
          const name = product.description || '';
          if (name && name.toLowerCase().includes(queryLower)) {
            suggestions.push({
              text: name,
              type: 'product',
              category: product.category || ''
            });
          }
        });

        // Add category suggestions
        const categories = ['dress', 'jewelry', 'shoes', 'bags', 'accessories'];
        categories.forEach(cat => {
          if (cat && cat.toLowerCase().includes(queryLower)) {
            suggestions.push({
              text: cat.charAt(0).toUpperCase() + cat.slice(1),
              type: 'category',
              category: cat
            });
          }
        });

        // Add search history suggestions
        searchHistory.forEach(term => {
          if (term && term.toLowerCase().includes(queryLower) && !suggestions.find(s => s.text.toLowerCase() === term.toLowerCase())) {
            suggestions.push({
              text: term,
              type: 'history'
            });
          }
        });

        // Remove duplicates and limit to 8 suggestions
        const uniqueSuggestions = suggestions.filter((suggestion, index, self) => 
          index === self.findIndex(s => s.text.toLowerCase() === suggestion.text.toLowerCase())
        ).slice(0, 8);

        if (uniqueSuggestions.length > 0) {
          let html = '';
          uniqueSuggestions.forEach((suggestion, index) => {
            let icon, color;
            
            if (suggestion.type === 'product') {
              // Get the appropriate icon based on product category
              const category = suggestion.category || '';
              switch(category.toLowerCase()) {
                case 'dress':
                  icon = 'fas fa-female';
                  color = '#ff69b4';
                  break;
                case 'shoes':
                  icon = 'fas fa-shoe-prints';
                  color = '#8B4513';
                  break;
                case 'jewelry':
                  icon = 'fas fa-gem';
                  color = '#FFD700';
                  break;
                case 'bags':
                  icon = 'fas fa-shopping-bag';
                  color = '#8A2BE2';
                  break;
                case 'accessories':
                  icon = 'fas fa-glasses';
                  color = '#4682B4';
                  break;
                default:
                  icon = 'fas fa-tshirt';
                  color = '#ff69b4';
              }
            } else if (suggestion.type === 'category') {
              icon = 'fas fa-tag';
              color = '#4CAF50';
            } else {
              icon = 'fas fa-history';
              color = '#666';
            }
            
            const bgColor = index === selectedAutocompleteIndex ? '#f0f0f0' : '#fff';
            html += `<div class="autocomplete-item" data-index="${index}" data-text="${suggestion.text}" data-type="${suggestion.type}" data-category="${suggestion.category || ''}" style="padding:12px 15px;cursor:pointer;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;color:#333;background:${bgColor};transition:background 0.2s ease;">
                       <i class="${icon}" style="color:${color};width:16px;font-size:14px;"></i>
                       <span style="font-weight:500;">${suggestion.text}</span>
                     </div>`;
          });
          $('#autocompleteDropdown').html(html).show();
        } else {
          $('#autocompleteDropdown').hide();
        }
      }

      function selectAutocompleteItem(index) {
        const items = $('#autocompleteDropdown .autocomplete-item');
        if (index >= 0 && index < items.length) {
          items.removeClass('selected');
          $(items[index]).addClass('selected');
          selectedAutocompleteIndex = index;
        }
      }

      function applyAutocompleteSelection() {
        const selectedItem = $('#autocompleteDropdown .autocomplete-item.selected');
        if (selectedItem.length > 0) {
          const text = selectedItem.data('text');
          const type = selectedItem.data('type');
          const category = selectedItem.data('category');

          $('#searchBox').val(text);
          $('#autocompleteDropdown').hide();

          // Add to search history
          if (!searchHistory.includes(text)) {
            searchHistory.unshift(text);
            searchHistory = searchHistory.slice(0, 10); // Keep only last 10 searches
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
          }

          // If it's a category, set the category filter
          if (type === 'category' && category) {
            $('#categoryFilter').val(category);
          }

          filterProducts();
        }
      }

      function filterProducts() {
        const search = $('#searchBox').val().trim().toLowerCase();
        const category = $('#categoryFilter').val();
        filteredProducts = allProducts.filter(item => {
          const title = (item.description || '').toLowerCase();
          const matchSearch = title.includes(search);
          const matchCategory = !category || (item.category && item.category === category);
          return matchSearch && matchCategory;
        });
        currentPage = 1;
        renderProducts();
      }

      function renderProducts() {
        const container = $('#guestProducts');
        container.html('');
        $('#pagination').remove();
        if (filteredProducts.length === 0) {
          container.html('<p style="color:#ff69b4;text-align:center;width:100%;">No products found.</p>');
          return;
        }
        // Pagination logic
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        if (currentPage > totalPages) currentPage = 1;
        const start = (currentPage - 1) * productsPerPage;
        const end = start + productsPerPage;
        const pageProducts = filteredProducts.slice(start, end);
        pageProducts.forEach(item => {
          container.append(`
            <div class="card" data-category="${item.category || ''}" style="background: linear-gradient(135deg, #ffb6c1 0%, #ff69b4 100%); color: #222; border-radius: 15px; padding: 20px 16px 18px 16px; text-align: center; transition: 0.3s; box-shadow: 0 0 10px rgba(255, 105, 180, 0.1); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; width: 260px; min-height: 370px; max-width: 100%; margin-bottom: 20px;">
              <img src="/images/${item.product_image}" alt="${item.description}" style="width: 100%; max-width: 210px; max-height: 210px; height: auto; object-fit: contain; background-color: #fff; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(255, 105, 180, 0.08);">
              <h3 style="color: #1a1a1a; font-family: 'Playfair Display', serif; font-size: 2.1em; font-weight: 800; margin: 18px 0 8px 0;">${item.description}</h3>
              <p style="color: #333; font-size: 1.18em; font-weight: 600; margin: 8px 0 6px 0;">${item.category ? item.category.charAt(0).toUpperCase() + item.category.slice(1) : ''}</p>
              <p style="color: #333; font-size: 1.18em; font-weight: 600; margin: 8px 0 6px 0;">â‚±${item.sell_price}</p>
              <a href="#" class="btn small" style="color: #ff69b4; font-weight: 800; font-size: 1.1em; letter-spacing: 0.5px; background-color: #111; border-radius: 30px; padding: 10px 20px; margin-top: 10px;">Shop Now</a>
              <div class="product-reviews" style="margin-top: 20px; text-align: center; width: 100%; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
                <div class="reviews-summary" style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                  <div class="rating-stars" style="font-size: 18px;">
                    ${generateStarHTML(item.average_rating || 0)}
                  </div>
                  <span style="font-size: 14px; color: #333; font-weight: 600;">(${item.total_reviews || 0} reviews)</span>
                </div>
                <button class="view-reviews-btn" data-item-id="${item.item_id}" style="background: #ff69b4; border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;">
                  <i class="fas fa-star"></i> View Reviews
                </button>
              </div>
            </div>
          `);
        });
        // Pagination controls
        let paginationHtml = '<div id="pagination" style="text-align:center;margin-top:24px;">';
        for (let i = 1; i <= totalPages; i++) {
          paginationHtml += `<button class="btn" style="margin:0 4px;${i===currentPage?'background:#ff69b4;color:#fff;':''}" data-page="${i}">${i}</button>`;
        }
        paginationHtml += '</div>';
        if (totalPages > 1) {
          container.after(paginationHtml);
        }
      }

      // Fetch all products with review data
      async function fetchProductsWithReviews() {
        try {
          const response = await fetch('http://localhost:3000/api/v1/items');
          const data = await response.json();
          allProducts = data.rows || [];
          
          // Fetch review data for each product
          const productsWithReviews = await Promise.all(
            allProducts.map(async (product) => {
              try {
                const reviewResponse = await fetch(`http://localhost:3000/api/v1/items/${product.item_id}/reviews`);
                const reviewData = await reviewResponse.json();
                return {
                  ...product,
                  average_rating: reviewData.average_rating || 0,
                  total_reviews: reviewData.total_reviews || 0
                };
              } catch (error) {
                console.error(`Error fetching reviews for product ${product.item_id}:`, error);
                return {
                  ...product,
                  average_rating: 0,
                  total_reviews: 0
                };
              }
            })
          );
          
          allProducts = productsWithReviews;
          filteredProducts = allProducts;
          currentPage = 1;
          renderProducts();
        } catch (error) {
          console.error('Error fetching products:', error);
          // Fallback to basic product fetch
          fetch('http://localhost:3000/api/v1/items')
            .then(res => res.json())
            .then(data => {
              allProducts = data.rows || [];
              filteredProducts = allProducts;
              currentPage = 1;
              renderProducts();
            });
        }
      }

      // Initialize products
      fetchProductsWithReviews();

      // Clear search function
      function clearSearch() {
        $('#searchBox').val('');
        $('#categoryFilter').val('');
        $('#autocompleteDropdown').hide();
        selectedAutocompleteIndex = -1;
        filteredProducts = allProducts;
        currentPage = 1;
        renderProducts();
      }

      // Search/filter events
      $('#searchBox, #categoryFilter').on('input change', filterProducts);
      $('#searchBtn').on('click', function (e) {
        e.preventDefault();
        filterProducts();
        $('#autocompleteDropdown').hide();
        selectedAutocompleteIndex = -1;
      });

      // Clear button click
      $('#clearBtn').on('click', function (e) {
        e.preventDefault();
        clearSearch();
      });

      // Autocomplete event handlers
      $('#searchBox').on('input', function() {
        try {
          const query = $(this).val();
          showAutocomplete(query);
          selectedAutocompleteIndex = -1;
        } catch (error) {
          console.error('Error in autocomplete:', error);
          $('#autocompleteDropdown').hide();
        }
      });

      $('#searchBox').on('keydown', function(e) {
        const items = $('#autocompleteDropdown .autocomplete-item');
        const itemCount = items.length;

        if (itemCount === 0) return;

        switch(e.keyCode) {
          case 40: // Down arrow
            e.preventDefault();
            selectedAutocompleteIndex = (selectedAutocompleteIndex + 1) % itemCount;
            selectAutocompleteItem(selectedAutocompleteIndex);
            break;
          case 38: // Up arrow
            e.preventDefault();
            selectedAutocompleteIndex = selectedAutocompleteIndex <= 0 ? itemCount - 1 : selectedAutocompleteIndex - 1;
            selectAutocompleteItem(selectedAutocompleteIndex);
            break;
          case 13: // Enter
            e.preventDefault();
            if ($('#autocompleteDropdown').is(':visible')) {
              applyAutocompleteSelection();
            } else {
              // If no autocomplete is visible, perform search
              const searchQuery = $(this).val().trim();
              if (searchQuery || $('#categoryFilter').val()) {
                filterProducts();
                $('#autocompleteDropdown').hide();
                selectedAutocompleteIndex = -1;
              }
            }
            break;
          case 27: // Escape
            $('#autocompleteDropdown').hide();
            selectedAutocompleteIndex = -1;
            break;
        }
      });

      // Click on autocomplete item
      $(document).on('click', '#autocompleteDropdown .autocomplete-item', function() {
        applyAutocompleteSelection();
      });

      // Hide autocomplete when clicking outside
      $(document).on('click', function(e) {
        if (!$(e.target).closest('#searchBox, #autocompleteDropdown').length) {
          $('#autocompleteDropdown').hide();
        }
      });

      // Hover effects for autocomplete items
      $(document).on('mouseenter', '#autocompleteDropdown .autocomplete-item', function() {
        $('#autocompleteDropdown .autocomplete-item').removeClass('selected');
        $(this).addClass('selected');
        selectedAutocompleteIndex = $(this).data('index');
      });

      // Pagination click
      $(document).on('click', '#pagination button', function() {
        currentPage = parseInt($(this).data('page'));
        renderProducts();
      });

      // View Reviews button click
      $(document).on('click', '.view-reviews-btn', function() {
        const itemId = $(this).data('item-id');
        const itemName = $(this).closest('.card').find('h3').text();
        showReviewsModal(itemId, itemName);
      });

      // Shop Now button click
      $(document).on('click', '.card .btn.small', function(e) {
        e.preventDefault();
        Swal.fire({
          title: 'Login Required',
          text: 'Please login or register to start shopping!',
          icon: 'info',
          showCancelButton: true,
          confirmButtonColor: '#ff69b4',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Login',
          cancelButtonText: 'Register',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = 'login.html';
          } else if (result.dismiss === Swal.DismissReason.cancel) {
            window.location.href = 'register.html';
          }
        });
      });

      // Infinite scroll event: go to next page if available
      $(window).on('scroll', function() {
        if (loading) return;
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
        if ($(window).scrollTop() + $(window).height() > $(document).height() - 120) {
          if (currentPage < totalPages) {
            loading = true;
            currentPage++;
            renderProducts();
            setTimeout(() => { loading = false; }, 400);
          }
        }
      });
    });
  </script>
  <script src="js/reviews.js"></script>

  <footer>
    <p>&copy; 2025 Fashionista. All rights reserved.</p>
  </footer>

</body>
</html>
